@startuml C4_Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_TOP_DOWN()
LAYOUT_WITH_LEGEND()

title Diagrama de Containers - Plataforma AllpFit Analytics

Person(admin, "Admin GeniAI", "Gerencia múltiplos tenants")
Person(client, "Usuário Cliente", "Visualiza analytics do seu tenant")

System_Boundary(analytics, "AllpFit Analytics Platform") {
    Container(nginx, "Nginx Reverse Proxy", "Nginx", "Proxy reverso, terminação SSL, balanceamento de carga")

    Container(streamlit_app, "Streamlit Dashboard", "Python/Streamlit", "Interface web interativa para visualização de analytics e KPIs")

    Container(fastapi, "FastAPI Backend", "Python/FastAPI", "API REST para operações administrativas e integrações")

    Container(etl_pipeline, "ETL Pipeline V3", "Python/Pandas", "Pipeline incremental de extração, transformação e carga de dados")

    Container(auth_module, "Módulo de Autenticação", "Python/bcrypt", "Autenticação multi-tenant com sessões e RLS")

    Container(analyzers, "Analyzers Module", "Python", "Análise de conversas: rule-based e AI-powered (GPT-4)")

    ContainerDb(local_db, "Banco Local Analytics", "PostgreSQL 15 + TimescaleDB", "Armazena dados de conversas, métricas, usuários e sessões com RLS")
}

System_Ext(chatwoot_db, "Banco Chatwoot", "PostgreSQL com views modulares")
System_Ext(openai_api, "OpenAI API", "GPT-4")
System_Ext(evo_api, "EVO CRM API", "REST API")

Rel(admin, nginx, "Acessa painel admin", "HTTPS/443")
Rel(client, nginx, "Acessa dashboard", "HTTPS/443")

Rel(nginx, streamlit_app, "Roteia requests", "HTTP/8504")
Rel(nginx, fastapi, "Roteia API calls", "HTTP/8000")

Rel(streamlit_app, auth_module, "Valida sessões, aplica RLS")
Rel(streamlit_app, local_db, "Lê dados filtrados por tenant", "PostgreSQL")

Rel(fastapi, local_db, "CRUD de tenants/usuários", "PostgreSQL")

Rel(etl_pipeline, chatwoot_db, "Extrai conversas incrementalmente", "PostgreSQL Read-Only")
Rel(etl_pipeline, local_db, "UPSERT dados transformados", "PostgreSQL")

Rel(analyzers, openai_api, "Analisa conversas", "HTTPS")
Rel(analyzers, evo_api, "Cross-match telefones", "HTTPS")
Rel(analyzers, local_db, "Persiste análises", "PostgreSQL")

Rel(auth_module, local_db, "Valida credenciais, gerencia sessões", "PostgreSQL")

SHOW_LEGEND()
@enduml
